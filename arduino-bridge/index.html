<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arduino Serial Terminal</title>
    <link rel="stylesheet" href="node_modules/xterm/css/xterm.css" />
    <link rel="stylesheet" href="/src/client/style.css" />
  </head>
  <body>
    <div class="header">
      <div class="branding">
        <svg
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M9 3V5H15V3H9ZM9 19V21H15V19H9ZM3 9H5V15H3V9ZM19 9H21V15H19V9Z"
            fill="#00979D"
          />
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M7 7H17V17H7V7ZM9 9H15V15H9V9Z"
            fill="#00979D"
          />
        </svg>
        <span>Arduino -<br />Codespaces<br />Bridge</span>
      </div>

      <div class="toolbar-group">
        <!-- Top Bar: Connection & Upload -->
        <div class="toolbar">
          <button id="connectBtn">Connect Port</button>
          <button id="disconnectBtn" disabled>Disconnect</button>
          <div class="separator"></div>
          <select id="boardType">
            <option value="arduino:avr:uno">Arduino Uno</option>
          </select>
          <select id="sketchSelect">
            <option value="">Select Sketch...</option>
          </select>
          <label
            class="checkbox-label"
            title="Include library example sketches in the dropdown"
          >
            <input type="checkbox" id="includeExamplesCheck" />
            <span>Examples</span>
          </label>
          <button id="compileBtn" disabled>Compile</button>
          <button id="compileUploadBtn" disabled>Compile & Upload</button>
        </div>

        <!-- Bottom Bar: Serial Functions -->
        <div class="toolbar">
          <select id="baudRate">
            <option value="300">300</option>
            <option value="1200">1200</option>
            <option value="2400">2400</option>
            <option value="4800">4800</option>
            <option value="9600">9600</option>
            <option value="19200">19200</option>
            <option value="38400">38400</option>
            <option value="57600">57600</option>
            <option value="74880">74880</option>
            <option value="115200" selected>115200</option>
            <option value="230400">230400</option>
            <option value="250000">250000</option>
            <option value="500000">500000</option>
            <option value="921600">921600</option>
            <option value="1000000">1000000</option>
            <option value="2000000">2000000</option>
          </select>
          <div class="separator"></div>
          <label
            style="
              display: flex;
              align-items: center;
              gap: 5px;
              color: #d4d4d4;
              font-size: 12px;
            "
          >
            <input type="checkbox" id="dtrCheck" /> DTR
          </label>
          <label
            style="
              display: flex;
              align-items: center;
              gap: 5px;
              color: #d4d4d4;
              font-size: 12px;
            "
          >
            <input type="checkbox" id="rtsCheck" /> RTS
          </label>
          <div class="separator"></div>
          <button id="toggleViewBtn">Switch to Plotter</button>
          <div class="separator"></div>
          <button id="freezePlotBtn" style="display: none">
            ‚è∏ Freeze Plot
          </button>
          <button id="downloadPlotBtn" style="display: none">
            üì∑ Save Plot as PNG
          </button>
          <div class="separator"></div>
          <label
            style="
              display: flex;
              align-items: center;
              gap: 5px;
              color: #d4d4d4;
              font-size: 12px;
            "
          >
            <input type="checkbox" id="timestampCheck" /> Show Timestamp
          </label>
          <button id="clearBtn">Clear Output</button>
          <button id="downloadBtn">Download Output</button>
        </div>
      </div>
    </div>

    <div id="bridge-status" class="status-banner hidden">
      <div class="status-text">
        <strong id="bridgeStatusText">Bridge status unknown</strong>
        <span id="bridgeStatusDetail"></span>
      </div>
      <button id="restartBridgeBtn" class="secondary-btn">
        Restart Bridge
      </button>
    </div>

    <!-- Main Navigation Tabs -->
    <div class="main-nav">
      <button class="nav-tab active" data-view="serial">
        <span class="nav-icon">‚å®Ô∏è</span> Serial Monitor
      </button>
      <button class="nav-tab" data-view="boards">
        <span class="nav-icon">üîß</span> Board Manager
      </button>
      <button class="nav-tab" data-view="libraries">
        <span class="nav-icon">üìö</span> Library Manager
      </button>
      <button class="nav-tab" data-view="reference">
        <span class="nav-icon">üìñ</span> Reference
      </button>
    </div>

    <!-- Serial Monitor View (Terminal/Plotter) -->
    <div id="serial-view" class="view-container active">
      <div id="main-content">
        <div id="terminal-container"></div>
        <div id="plotter-container"></div>
      </div>
    </div>

    <!-- Board Manager View -->
    <div id="boards-view" class="view-container">
      <div class="manager-header">
        <h2>Board Manager</h2>
        <div class="manager-controls">
          <input
            type="text"
            id="board-search"
            placeholder="Search boards and platforms..."
          />
          <label class="checkbox-label">
            <input type="checkbox" id="show-installed-boards" /> Installed only
          </label>
          <button id="manage-board-urls" class="secondary-btn">
            üîó Additional URLs
          </button>
          <button id="refresh-board-index" class="refresh-btn">
            üîÑ Update Index
          </button>
        </div>
        <div class="index-status" id="board-index-status"></div>
      </div>
      <div class="manager-list" id="board-list">
        <div class="loading-placeholder">Loading platforms...</div>
      </div>
      <div class="job-progress" id="board-job-progress" style="display: none">
        <div class="progress-header">
          <span class="progress-title">Operation in progress...</span>
          <button class="progress-close" id="close-board-progress">√ó</button>
        </div>
        <pre class="progress-log" id="board-progress-log"></pre>
      </div>

      <!-- Additional Board URLs Modal -->
      <div id="board-url-modal" class="modal-overlay" style="display: none">
        <div class="modal-content url-modal">
          <div class="modal-header">
            <h3>Additional Board Manager URLs</h3>
            <button class="modal-close" id="close-board-url-modal">√ó</button>
          </div>
          <div class="modal-body">
            <p class="modal-description">
              Add URLs for third-party board packages (e.g., ESP32, ESP8266,
              STM32). After adding a URL, click "Update Index" to download the
              board definitions.
            </p>
            <div class="url-input-group">
              <input
                type="url"
                id="board-url-input"
                placeholder="https://example.com/package_index.json"
              />
              <button id="add-board-url" class="btn-install">Add</button>
            </div>
            <div class="url-list" id="board-url-list">
              <div class="empty-urls">Loading...</div>
            </div>
            <div class="common-urls">
              <p class="common-urls-title">Common Board URLs:</p>
              <ul class="common-urls-list">
                <li>
                  <code
                    >https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json</code
                  >
                  - ESP32
                </li>
                <li>
                  <code
                    >https://arduino.esp8266.com/stable/package_esp8266com_index.json</code
                  >
                  - ESP8266
                </li>
                <li>
                  <code
                    >https://adafruit.github.io/arduino-board-index/package_adafruit_index.json</code
                  >
                  - Adafruit
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Library Manager View -->
    <div id="libraries-view" class="view-container">
      <div class="manager-header">
        <h2>Library Manager</h2>
        <div class="manager-controls">
          <input
            type="text"
            id="lib-search"
            placeholder="Search libraries..."
          />
          <select id="lib-category">
            <option value="All">All Categories</option>
            <option value="Communication">Communication</option>
            <option value="Data Processing">Data Processing</option>
            <option value="Data Storage">Data Storage</option>
            <option value="Device Control">Device Control</option>
            <option value="Display">Display</option>
            <option value="Sensors">Sensors</option>
            <option value="Signal Input/Output">Signal Input/Output</option>
            <option value="Timing">Timing</option>
            <option value="Other">Other</option>
          </select>
          <label class="checkbox-label">
            <input type="checkbox" id="show-installed-libs" /> Installed only
          </label>
          <button id="lib-custom-install" class="secondary-btn">
            üì¶ Install from URL/ZIP
          </button>
          <button id="refresh-lib-index" class="refresh-btn">
            üîÑ Update Index
          </button>
        </div>
        <div class="index-status" id="lib-index-status"></div>
      </div>
      <div class="manager-list" id="lib-list">
        <div class="loading-placeholder">
          Search for libraries to get started...
        </div>
      </div>
      <div class="job-progress" id="lib-job-progress" style="display: none">
        <div class="progress-header">
          <span class="progress-title">Operation in progress...</span>
          <button class="progress-close" id="close-lib-progress">√ó</button>
        </div>
        <pre class="progress-log" id="lib-progress-log"></pre>
      </div>

      <!-- Custom Library Install Modal -->
      <div id="lib-custom-modal" class="modal-overlay" style="display: none">
        <div class="modal-content custom-install-modal">
          <div class="modal-header">
            <h3>Install Library from URL or ZIP</h3>
            <button class="modal-close" id="close-lib-custom-modal">√ó</button>
          </div>
          <div class="modal-body">
            <!-- Git URL Section -->
            <div class="install-section">
              <h4>Install from Git Repository</h4>
              <p class="modal-description">
                Enter a Git repository URL to install the library directly from
                source.
              </p>
              <div class="url-input-group">
                <input
                  type="url"
                  id="lib-git-url"
                  placeholder="https://github.com/user/library-name.git"
                />
                <button id="install-lib-git" class="btn-install">
                  Install
                </button>
              </div>
              <div class="install-examples">
                <p class="example-title">Examples:</p>
                <code>https://github.com/arduino-libraries/Servo.git</code>
                <code>https://github.com/adafruit/Adafruit_NeoPixel.git</code>
              </div>
            </div>

            <div class="install-divider">
              <span>OR</span>
            </div>

            <!-- ZIP File Section -->
            <div class="install-section">
              <h4>Install from ZIP File</h4>
              <p class="modal-description">
                Enter the full path to a downloaded library ZIP file.
              </p>
              <div class="url-input-group">
                <input
                  type="text"
                  id="lib-zip-path"
                  placeholder="/path/to/library.zip"
                />
                <button id="install-lib-zip" class="btn-install">
                  Install
                </button>
              </div>
              <div class="install-examples">
                <p class="example-title">Example paths:</p>
                <code>/home/user/Downloads/MyLibrary.zip</code>
                <code>/workspaces/project/libs/CustomLib.zip</code>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reference View -->
    <div id="reference-view" class="view-container">
      <div class="manager-header">
        <h2>Arduino Language Reference</h2>
        <div class="manager-controls">
          <input
            type="text"
            id="ref-search"
            placeholder="Search functions, variables..."
          />
          <select id="ref-category">
            <option value="all">All Categories</option>
            <option value="digital">Digital I/O</option>
            <option value="analog">Analog I/O</option>
            <option value="time">Time</option>
            <option value="math">Math</option>
            <option value="serial">Serial</option>
            <option value="variables">Variables</option>
            <option value="structure">Structure</option>
          </select>
          <button id="refresh-reference" class="refresh-btn">üîÑ Refresh</button>
          <a
            href="https://docs.arduino.cc/language-reference/"
            target="_blank"
            class="secondary-btn"
          >
            üîó Full Docs
          </a>
        </div>
      </div>
      <div class="reference-content" id="reference-content">
        <div class="loading-placeholder">Loading Arduino reference...</div>
      </div>
    </div>

    <div class="input-bar">
      <input
        type="text"
        id="serialInput"
        placeholder="Type command..."
        disabled
      />
      <select id="lineEnding">
        <option value="none">No line ending</option>
        <option value="nl">Newline</option>
        <option value="cr">Carriage return</option>
        <option value="nlcr" selected>Both NL & CR</option>
      </select>
      <button id="sendBtn" disabled>Send</button>
    </div>

    <!-- Bootloader Modal -->
    <div
      id="bootloaderModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: #252526;
          padding: 20px;
          border-radius: 5px;
          border: 1px solid #007acc;
          max-width: 400px;
          text-align: center;
          color: #cccccc;
          font-family: 'Segoe UI', sans-serif;
        "
      >
        <h3 style="margin-top: 0; color: #ffffff">‚ö†Ô∏è Device Reset Required</h3>
        <p>The device is resetting into bootloader mode.</p>
        <p>
          Please wait for the LED to pulse (approx 2-3s), then click below to
          select the new port.
        </p>
        <div style="margin-top: 20px">
          <button
            id="modalSelectPortBtn"
            style="
              background: #007acc;
              color: white;
              border: none;
              padding: 8px 16px;
              cursor: pointer;
              border-radius: 2px;
            "
          >
            Select Port & Continue
          </button>
          <button
            id="modalCancelBtn"
            style="
              background: #3c3c3c;
              color: white;
              border: none;
              padding: 8px 16px;
              cursor: pointer;
              margin-left: 10px;
              border-radius: 2px;
            "
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Board Mismatch Warning Modal -->
    <div
      id="mismatchModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: #252526;
          padding: 20px;
          border-radius: 5px;
          border: 1px solid #f59e0b;
          max-width: 450px;
          text-align: center;
          color: #cccccc;
          font-family: 'Segoe UI', sans-serif;
        "
      >
        <h3 style="margin-top: 0; color: #f59e0b">‚ö†Ô∏è Board Mismatch Warning</h3>
        <p id="mismatchMessage">
          The connected device does not appear to match the selected board.
        </p>
        <p style="font-size: 12px; color: #888">
          Connected: <span id="mismatchConnected">Unknown</span><br />
          Selected: <span id="mismatchSelected">Unknown</span>
        </p>
        <p style="font-size: 13px; color: #aaa">
          Uploading to the wrong board type may fail or damage the device.
        </p>
        <div style="margin-top: 20px">
          <button
            id="mismatchContinueBtn"
            style="
              background: #f59e0b;
              color: black;
              border: none;
              padding: 8px 16px;
              cursor: pointer;
              border-radius: 2px;
              font-weight: bold;
            "
          >
            Upload Anyway
          </button>
          <button
            id="mismatchCancelBtn"
            style="
              background: #3c3c3c;
              color: white;
              border: none;
              padding: 8px 16px;
              cursor: pointer;
              margin-left: 10px;
              border-radius: 2px;
            "
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <script type="module" src="/src/client/main.js"></script>
  </body>
</html>
